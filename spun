#!/bin/bash
# simple pacman update notifier
# a very simplistic update notification script written 
# in bash, using notify-send and kdialog. 
# NOTE: For this to work, 'pacman -Sy' must be allowed w/o password by sudo

daemon=${daemon-1}
pacmanconf=/etc/pacman.conf
# Wait time in minutes before updating again - must be integer
waittime=5

main() {
  # Calculate seconds to sleep:
  [[ $waittime -le 10080 && $waittime -ge 1 ]] && 
    let sleeptime=$waittime*60 ||
    fail "Bad value for 'waittime' variable.\nMust be an integer between 1 and 10080."
  if [[ $daemon == 1 ]]; then 
    daemon
  else
    dothings
  fi
}

isignored() {
  IFS=$'\n'" "
  local ignoredpkgs=( $(grep '^ *IgnorePkg' "$pacmanconf" | cut -d '=' -f 2-) )
  IFS=' '
  grep -q "^$1$" <<< "${ignoredpkgs[@]}"
}

check() {
  #tmpdir=/tmp/spun/
  #[[ -d $tmpdir ]] || mkdir -p $tmpdir && local dbpath=$tmpdir
  #fakeroot pacman -Syy --dbpath /tmp/spun >&2>$tmpdir/log
  #pacman -Quq --dbpath $dbpath | tee -a $tmpdir/log
  sudo pacman -Sy >&2>/dev/null
  pacman -Quq
}

daemon() {
  echo -n ":: Starting simple-update-notifier... "
  dothings &
  echo "         [Done]"
}

gui() {
  echo -n # may be added later
}

dothings() {
  upkgz=( )
  while true; do
    for pkg in $(check); do
      if isignored $pkg; then continue
      else upkgz+=( $pkg ); fi
    done
    [[ -n $upkgz ]] && notify "${upkgz[@]}"
    sleep $sleeptime
  done
}

notify() {
  notify-send -i info 'There are updates available!' "Updates are availabe for the following package(s): \n${upkgz[*]}"
}

fail() {
  [[ $gui != 1 ]] && printf "$1\n" ||
    kdialog --error "$1"
  exit 1
}

main
